---
import EnableNotificationToggle from "@/components/EnableNotificationToggle.astro";
import FileList from "@/components/FileList.astro";
import FolderList from "@/components/FolderList.astro";
import NewFolderButton from "@/components/NewFolderButton.astro";
import SignIn from "@/components/SignIn/index.astro";
import Layout from "@/layouts/Layout.astro";
import { fileService, folderService } from "@/services";
import { getUser, isAuthenticated } from "@/utils/auth";

let folders = null;
let files = null;
let user = null;

const userIsAuthenticated = isAuthenticated(Astro.cookies);

if (userIsAuthenticated) {
  user = getUser(Astro.cookies);

  if (user) {
    folders = await folderService.getFolders(user.id);
    files = await fileService.getFiles(user.id);
  }
}

const fileCount = files?.length ? `(${files.length})` : "";
---

<Layout title="Home | PingMe">
  {!userIsAuthenticated && <SignIn />}

  {
    userIsAuthenticated && user && (
      <div style="display: flex; justify-content: center; margin-bottom: 2rem">
        <EnableNotificationToggle userId={user.id} />
      </div>
    )
  }

  {
    userIsAuthenticated && folders && (
      <section>
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <h2>Folders</h2>

          <NewFolderButton />
        </div>

        <FolderList folders={folders} />
      </section>
    )
  }

  {
    userIsAuthenticated && (
      <section>
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <h2>Files {fileCount}</h2>

          <a href="/file/new" title="Create file">
            <span>âž•</span>
          </a>
        </div>

        {files && <FileList files={files} />}
      </section>
    )
  }
</Layout>

<style>
  main {
    padding: 1.5rem;
  }

  section {
    background-color: var(--section-background);
    border-radius: 0.5rem;
    padding: 1.5rem;
    padding-top: 0.5rem;
    margin-bottom: 1.5rem;
    box-shadow: var(--shadow);
  }

  section h2 {
    color: var(--black);
  }

  li {
    margin-bottom: 1rem;
  }

  a {
    text-decoration: none;
  }

  a span {
    font-size: 2rem;
  }
</style>
